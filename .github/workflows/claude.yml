name: Claude Code Base Action

on:
  # 1. å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:
    inputs:
      prompt:
        description: "ç»™ Claude çš„æç¤ºè¯"
        required: true
        default: "è¯·å¸®æˆ‘ç®€è¦åˆ†æè¿™ä¸ªé¡¹ç›®ç»“æ„"

  # 2. å½“ PR è¢«æ‰“å¼€æ—¶è‡ªåŠ¨è§¦å‘
  pull_request:
    types: [opened]
  issue_comment:
    types: [created]

jobs:
  claude-task:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      - name: åˆ¤æ–­æ˜¯å¦æåŠclaude
        id: check_mention
        run: |
           COMMENT="${{ github.event.comment.body }}"
           if echo "$COMMENT" | grep -iE "@claude" > /dev/null; then
             echo "trigger=true" >> $GITHUB_OUTPUT
             # æŠŠ @claude å»æ‰ï¼Œå‰©ä¸‹çš„ä½œä¸ºé—®é¢˜
             PROMPT=$(echo "$COMMENT" | sed -E 's/@claude//gi')
             echo "prompt=$PROMPT" >> $GITHUB_OUTPUT
           else
             echo "trigger=false" >> $GITHUB_OUTPUT
           fi
      - name: è¿è¡Œ Claude Code Base
        if: steps.check_mention.outputs.trigger == 'true'
        uses: anthropics/claude-code-base-action@beta
        id: claude
        env:
          ANTHROPIC_BASE_URL: https://www.elbnt.ai
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          model: "claude-opus-4-6"
          allowed_tools: "Bash(git:*),View,GlobTool,GrepTool,BatchTool"
          system_prompt: |
            ä½ æ˜¯ä¸“ä¸šä»£ç å®¡æŸ¥åŠ©æ‰‹ã€‚
          prompt: |
            è¯·å®¡æŸ¥è¿™ä¸ªPRçš„ä»£ç ï¼Œç»™å‡ºæ”¹è¿›å»ºè®®ã€‚
          max_tokens: 65536
          temperature: 0.7
      - name: Extract and Comment PR Review
        if: steps.claude.outputs.conclusion == 'success'
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const executionFile = '${{ steps.claude.outputs.execution_file }}';
            const executionLog = JSON.parse(fs.readFileSync(executionFile, 'utf8'));

            // Extract the review content from the execution log
            // The execution log contains the full conversation including Claude's responses
            let review = '';
            // é€‚é…ä½ çœŸå®çš„ JSON ç»“æ„
            for (const item of executionLog) {
              // ç›´æ¥å–æœ€ç»ˆç»“æœ
              if (item.type === 'result' && item.subtype === 'success') {
                review = item.result;
              }
              // å…œåº•ï¼šä» assistant æ¶ˆæ¯å–
              if (item.type === 'assistant' && item.message?.content?.[0]?.text) {
                review = item.message.content[0].text;
              }
            }
            console.log("æ‹¿åˆ°çš„ review å†…å®¹ï¼š", review);
            if (review) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: "ğŸ¤– Claude åˆ†æç»“æœ\n\n" + review + "\n\n*Generated by Claude Code*"
              });
            }
